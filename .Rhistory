"charging_5mile" = "Fast charger",
"rangeanxiety" = "Range")) %>%
mutate(stage = factor(stage, levels = stage_order)) %>%
group_by(tech) %>%
mutate(
value = replace_na(value, 0),
start = cumsum(lag(value, default = 0)),  # cumulative start
end = start + value
) %>%
mutate(tech = factor(tech, levels = c("PS","PV","EV","HP","IC"))) %>%
mutate(scene = "Pessimistic")
dff <- df_long_p %>%
filter(value >0) %>%
mutate(across(where(is.numeric), ~ .x * 100)) %>%
group_by(tech) %>%
mutate(id = row_number(),
label_val = if_else(value != 0, as.character(round(value, 0)), "")) %>%
ungroup() %>% # Ungrouping is good practice after mutations
mutate(class = ifelse(stage %in% c("Current","Future"), "No subsidy",
ifelse(stage %in% c("Low"), "Policy intervention",
"Time variant")),
class = factor(class, levels = c("No subsidy","Policy intervention","Time variant")))
segment_data <- dff %>%
group_by(tech) %>%
filter(id < max(id)) %>%
filter(tech != "PV") %>%
mutate(tech = recode(tech,
"PS" = "PV + Storage",
"EV" = "Electric vehicles",
"HP" = "Heat pumps",
"IC" = "Induction stoves")) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps","Induction stoves")))
hlines <- tibble::tribble(
~tech, ~y_intercept, ~line_label,
"PV + Storage", 20, "Base: 0.20",
"Electric vehicles", 42, "Base: 0.42",
"Heat pumps", 46,   "Base: 46" # This line will not appear as there is no "HP" data
) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps")))
pess_result <- dff %>%
filter(tech != "PV") %>%
mutate(tech = recode(tech,
"PS" = "PV + Storage",
"EV" = "Electric vehicles",
"HP" = "Heat pumps",
"IC" = "Induction stoves")) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps","Induction stoves")))
da <- opt_result %>%
mutate(
id = ifelse(class == "Time variant", 4, id)   # stack on top of More subsidy
) %>%
rbind(
pess_result %>%
filter(class == "Time variant") %>%
mutate(
id = 3
)
)
# Identify the time-variant stages
time_variant_stages <- unique(da$stage[da$class == "Time variant"])
fill_vals <- c(
setNames(RColorBrewer::brewer.pal(length(time_variant_stages), "Set2"),
time_variant_stages),
"Other" = "azure3"
)
pattern_vals <- c(
setNames(rep("stripe", length(time_variant_stages)), time_variant_stages),
"Other" = "none"
)
da %>%
mutate(sta = as.character(stage),
ST = ifelse(class == "Time variant", sta, "Other"),
ST = factor(ST, levels = c("Peer effects","Home built after 2020","Fast charger","Range", "Other"))) %>%
ggplot(aes(x = stage)) +
geom_rect_pattern(
aes(
xmin = id - 0.45,
xmax = id + 0.45,
ymin = start,
ymax = end,
fill = ST,
pattern = ST
),
pattern_fill = "black",
pattern_angle = 45,
pattern_density = 0.02,
pattern_spacing = 0.03,
color = NA
) +
geom_hline(
data = hlines %>% filter(tech != "PV"),
aes(yintercept = y_intercept),
color = "darkred",
linetype = "dashed",
linewidth = 1
) +
facet_wrap(~ tech, scales = "free_x", nrow = 1) +
scale_x_discrete(limits = c("Current", "Future", "Low", "High")) +
scale_y_continuous(labels = scales::comma) +
scale_fill_manual(values = fill_vals, name = "",
breaks = time_variant_stages) +
scale_pattern_manual(values = pattern_vals, name = "",
breaks = time_variant_stages) +
labs(
title = "",
x = "",
y = "Cumulative Adoption (%)"
) +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
plot.title = element_text(face = "bold", size = 16),
legend.position = "right",
strip.text = element_text(size = 14, face = "bold"),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank()
)
### combination
daa <- d %>%
mutate(across(c("value"), ~ .x*0.55)) %>%
left_join(da %>%
mutate(across(c("value"), ~ .x*0.45)) %>%
dplyr::select(tech, stage, value, scene), by = c("tech","stage","scene")) %>%
mutate(value.y = ifelse(is.na(value.y), 0, value.y),
value = value.x + value.y) %>%
dplyr::select(-start, -end) %>%
filter(scene == "Optimistic") %>%
group_by(tech) %>%
mutate(
start = cumsum(lag(value, default = 0)),  # cumulative start
end = start + value
) %>%
rbind(
d %>%
mutate(across(c("value"), ~ .x*0.55)) %>%
left_join(da %>%
mutate(across(c("value"), ~ .x*0.45)) %>%
dplyr::select(tech, stage, value, scene), by = c("tech","stage","scene")) %>%
mutate(value.y = ifelse(is.na(value.y), 0, value.y),
value = value.x + value.y) %>%
dplyr::select(-start, -end) %>%
filter(id %in% c(1,2,3)) %>%
filter(scene == "Optimistic") %>%
rbind(
d %>%
mutate(across(c("value"), ~ .x*0.55)) %>%
left_join(da %>%
mutate(across(c("value"), ~ .x*0.45)) %>%
dplyr::select(tech, stage, value, scene), by = c("tech","stage","scene")) %>%
mutate(value.y = ifelse(is.na(value.y), 0, value.y),
value = value.x + value.y) %>%
dplyr::select(-start, -end) %>%
filter(scene == "Pessimistic")
) %>%
group_by(tech) %>%
mutate(
start = cumsum(lag(value, default = 0)),  # cumulative start
end = start + value
) %>%
filter(scene == "Pessimistic")
)
# Identify the time-variant stages
time_variant_stages <- unique(daa$stage[daa$class == "Time variant"])
fill_vals <- c(
setNames(RColorBrewer::brewer.pal(length(time_variant_stages), "Set2"),
time_variant_stages),
"Other" = "azure3"
)
pattern_vals <- c(
setNames(rep("stripe", length(time_variant_stages)), time_variant_stages),
"Other" = "none"
)
daa %>%
mutate(sta = as.character(stage),
ST = ifelse(class == "Time variant", sta, "Other"),
ST = factor(ST, levels = c("Peer effects","Home built after 2020","Fast charger","Range", "Other"))) %>%
ggplot(aes(x = stage)) +
geom_rect_pattern(
aes(
xmin = id - 0.45,
xmax = id + 0.45,
ymin = start,
ymax = end,
fill = ST,
pattern = ST
),
pattern_fill = "black",
pattern_angle = 45,
pattern_density = 0.02,
pattern_spacing = 0.03,
color = NA
) +
geom_hline(
data = hlines %>% filter(tech != "PV"),
aes(yintercept = y_intercept),
color = "darkred",
linetype = "dashed",
linewidth = 1
) +
facet_wrap(~ tech, scales = "free_x", nrow = 1) +
scale_x_discrete(limits = c("Current", "Future", "Low", "High")) +
scale_y_continuous(labels = scales::comma) +
scale_fill_manual(values = fill_vals, name = "",
breaks = time_variant_stages) +
scale_pattern_manual(values = pattern_vals, name = "",
breaks = time_variant_stages) +
labs(
title = "",
x = "",
y = "Cumulative Adoption (%)"
) +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
plot.title = element_text(face = "bold", size = 16),
legend.position = "right",
strip.text = element_text(size = 14, face = "bold"),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank()
)
source("./syntax/Function.R")
ggsave <- function(..., bg = 'white') ggplot2::ggsave(..., bg = bg)
remove <- c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv")
## average adoption
d1 <- data %>% # only homeowners
filter(home_own == 1) %>%
summarise(across(
.cols = all_of(names(.)[str_detect(names(.), "PV|EV|HP|IC|PS")& !str_detect(names(.), "peer")]),
.fns = ~ weighted.mean(.x, wt_ca, na.rm = TRUE)
)) %>%
gather(key, adoption) %>%
mutate(
tech = str_extract(key, "(PV|PS|EV|HP|IC)"),
scenario = case_when(
!str_detect(key, "^future") ~ "current",
str_detect(key, "0|(PV$)") ~ "Future",
str_detect(key, "low") ~ "Lsubsidy",
str_detect(key, "high") ~ "Hsubsidy",
TRUE ~ "future"  # fallback for keys like "future_PV"
)
) %>%
dplyr::select(-key) %>%
pivot_wider(names_from = scenario, values_from = adoption) %>%
mutate(
future = Future - current,
low.subsidy = Lsubsidy - Future,
high.subsidy = Hsubsidy - Lsubsidy
) %>%
dplyr::select(-Future,-Lsubsidy,-Hsubsidy)
### optimistic scenarios
select_var <- list(c("peer","home_age"),
c("peer","charging_5mile_f1","rangeanxiety","home_age"),
c("peer"),
c("peer"),
c("peer","home_age"))
rates <- list(c(0,0.2,-0.14,-0.23),
c(0,0.2,-2, 0.32,-0.04,-0.26), # brandnew, newer, range, charge, peer, none,
c(0,-0.25),
c(0,-0.17),
c(0,0.2,-0.14,-0.23))
result <- data.frame()
for(k in 2:5){
### without sum contrasts for scenario variables
b_ev <- mreg_scene(data = data %>%
filter(home_own == 1) %>%
dplyr::select(VAR[[k-1]], matches("home_own", ignore.case = FALSE),
climatezone, dac, matches("PV|PS|EV|HP|IC", ignore.case = FALSE),wt_ca),
remove = "home_own",
i = k,
scenario = select_var[[k]],
future = "high")
pattern <- paste(select_var[[k]], collapse = "|")
df <- b_ev %>%
filter(str_detect(var, pattern)) %>%
dplyr::select(var, Estimate) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(effect = Estimate*rate)
rd <- df %>%
summarise(
peer            = sum(effect[str_detect(var, "peer")], na.rm = TRUE),
home_age            = sum(effect[str_detect(var, "home_age")], na.rm = TRUE),
charging_5mile  = sum(effect[str_detect(var, "charging_5mile_f1")], na.rm = TRUE),
rangeanxiety    = sum(effect[str_detect(var, "rangeanxiety")], na.rm = TRUE)
) %>%
mutate(tech = ipt[k])
result <- rbind(rd, result)
}
stage_order <- c("Current", "Future", "Low", "High",
"Peer effects", "Home built after 2020", "Fast charger", "Range")
df_long <- d1 %>%
left_join(result, by = "tech")  %>%
pivot_longer(cols = -tech, names_to = "stage", values_to = "value") %>%
mutate(stage = recode(stage,
"current" = "Current",
"future" = "Future",
"low.subsidy" = "Low",
"high.subsidy" = "High",
"peer" = "Peer effects",
"home_age" = "Home built after 2020",
"charging_5mile" = "Fast charger",
"rangeanxiety" = "Range")) %>%
mutate(stage = factor(stage, levels = stage_order)) %>%
group_by(tech) %>%
mutate(
value = replace_na(value, 0),
start = cumsum(lag(value, default = 0)),  # cumulative start
end = start + value
) %>%
mutate(tech = factor(tech, levels = c("PS","PV","EV","HP","IC"))) %>%
mutate(scene = "Optimistic")
dff <- df_long %>%
filter(value >0) %>%
mutate(across(where(is.numeric), ~ .x * 100)) %>%
group_by(tech) %>%
mutate(id = row_number(),
label_val = if_else(value != 0, as.character(round(value, 0)), "")) %>%
ungroup() %>% # Ungrouping is good practice after mutations
mutate(class = ifelse(stage %in% c("Current","Future"), "No subsidy",
ifelse(stage %in% c("Low","High"), "Policy intervention",
"Time variant")),
class = factor(class, levels = c("No subsidy","Policy intervention","Time variant")))
segment_data <- dff %>%
group_by(tech) %>%
filter(id < max(id)) %>%
filter(tech != "PV") %>%
mutate(tech = recode(tech,
"PS" = "PV + Storage",
"EV" = "Electric vehicles",
"HP" = "Heat pumps",
"IC" = "Induction stoves")) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps","Induction stoves")))
hlines <- tibble::tribble(
~tech, ~y_intercept, ~line_label,
"PV + Storage", 20, "Base: 0.20",
"Electric vehicles", 42, "Base: 0.42",
"Heat pumps", 46,   "Base: 46" # This line will not appear as there is no "HP" data
) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps")))
opt_result <- dff %>%
filter(tech != "PV") %>%
mutate(tech = recode(tech,
"PS" = "PV + Storage",
"EV" = "Electric vehicles",
"HP" = "Heat pumps",
"IC" = "Induction stoves")) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps","Induction stoves")))
### pessimistic scenarios
tech <- c("PV","EV","HP","IC","PS")
select_var <- list(c("peer","home_age"),
c("peer","charging_5mile_f1","rangeanxiety", "home_age"),
c("peer"),
c("peer"),
c("peer","home_age"))
rates_p <- list(c(0,0.09,0,-0.18), #new, newer, peer, none
c(0, 0.09, -1, 0.16,0,-0.15), #range, charging, peer, none,
c(0,-0.11),
c(0,-0.07),
c(0,0.09,0,-0.18))
result_p <- data.frame()
for(k in 2:5){
b_ev <- mreg_scene(data = data %>%
filter(home_own == 1) %>%
dplyr::select(VAR[[k-1]], matches("home_own", ignore.case = FALSE),
climatezone, dac, matches("PV|PS|EV|HP|IC", ignore.case = FALSE),wt_ca),
remove = "home_own",
i = k,
scenario = select_var[[k]],
future = "low")
pattern <- paste(select_var[[k]], collapse = "|")
df <- b_ev %>%
filter(str_detect(var, pattern)) %>%
dplyr::select(var, Estimate) %>%
cbind(tibble(rate = rates_p[[k]])) %>%
mutate(effect = Estimate*rate)
rd <- df %>%
summarise(
peer            = sum(effect[str_detect(var, "peer")], na.rm = TRUE),
home_age            = sum(effect[str_detect(var, "home_age")], na.rm = TRUE),
charging_5mile  = sum(effect[str_detect(var, "charging_5mile_f1")], na.rm = TRUE),
rangeanxiety    = sum(effect[str_detect(var, "rangeanxiety")], na.rm = TRUE)
) %>%
mutate(tech = tech[k])
result_p <- rbind(rd, result_p)
}
df_long_p <- d1 %>%
dplyr::select(-high.subsidy) %>%
left_join(result_p, by = "tech")  %>%
pivot_longer(cols = -tech, names_to = "stage", values_to = "value") %>%
mutate(stage = recode(stage,
"current" = "Current",
"future" = "Future",
"low.subsidy" = "Low",
"high.subsidy" = "High",
"peer" = "Peer effects",
"home_age" = "Home built after 2020",
"charging_5mile" = "Fast charger",
"rangeanxiety" = "Range")) %>%
mutate(stage = factor(stage, levels = stage_order)) %>%
group_by(tech) %>%
mutate(
value = replace_na(value, 0),
start = cumsum(lag(value, default = 0)),  # cumulative start
end = start + value
) %>%
mutate(tech = factor(tech, levels = c("PS","PV","EV","HP","IC"))) %>%
mutate(scene = "Pessimistic")
dff <- df_long_p %>%
filter(value >0) %>%
mutate(across(where(is.numeric), ~ .x * 100)) %>%
group_by(tech) %>%
mutate(id = row_number(),
label_val = if_else(value != 0, as.character(round(value, 0)), "")) %>%
ungroup() %>% # Ungrouping is good practice after mutations
mutate(class = ifelse(stage %in% c("Current","Future"), "No subsidy",
ifelse(stage %in% c("Low"), "Policy intervention",
"Time variant")),
class = factor(class, levels = c("No subsidy","Policy intervention","Time variant")))
segment_data <- dff %>%
group_by(tech) %>%
filter(id < max(id)) %>%
filter(tech != "PV") %>%
mutate(tech = recode(tech,
"PS" = "PV + Storage",
"EV" = "Electric vehicles",
"HP" = "Heat pumps",
"IC" = "Induction stoves")) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps","Induction stoves")))
hlines <- tibble::tribble(
~tech, ~y_intercept, ~line_label,
"PV + Storage", 20, "Base: 0.20",
"Electric vehicles", 42, "Base: 0.42",
"Heat pumps", 46,   "Base: 46" # This line will not appear as there is no "HP" data
) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps")))
pess_result <- dff %>%
filter(tech != "PV") %>%
mutate(tech = recode(tech,
"PS" = "PV + Storage",
"EV" = "Electric vehicles",
"HP" = "Heat pumps",
"IC" = "Induction stoves")) %>%
mutate(tech = factor(tech, levels = c("PV + Storage","Electric vehicles","Heat pumps","Induction stoves")))
d <- opt_result %>%
mutate(
id = ifelse(class == "Time variant", 4, id)   # stack on top of More subsidy
) %>%
rbind(
pess_result %>%
filter(class == "Time variant") %>%
mutate(
id = 3
)
)
# Identify the time-variant stages
time_variant_stages <- unique(d$stage[d$class == "Time variant"])
fill_vals <- c(
setNames(RColorBrewer::brewer.pal(length(time_variant_stages), "Set2"),
time_variant_stages),
"Other" = "azure3"
)
pattern_vals <- c(
setNames(rep("stripe", length(time_variant_stages)), time_variant_stages),
"Other" = "none"
)
d %>%
mutate(sta = as.character(stage),
ST = ifelse(class == "Time variant", sta, "Other"),
ST = factor(ST, levels = c("Peer effects","Home built after 2020","Fast charger","Range", "Other"))) %>%
ggplot(aes(x = stage)) +
geom_rect_pattern(
aes(
xmin = id - 0.45,
xmax = id + 0.45,
ymin = start,
ymax = end,
fill = ST,
pattern = ST
),
pattern_fill = "black",
pattern_angle = 45,
pattern_density = 0.02,
pattern_spacing = 0.03,
color = NA
) +
geom_hline(
data = hlines %>% filter(tech != "PV"),
aes(yintercept = y_intercept),
color = "darkred",
linetype = "dashed",
linewidth = 1
) +
facet_wrap(~ tech, scales = "free_x", nrow = 1) +
scale_x_discrete(limits = c("Current", "Future", "Low", "High")) +
scale_y_continuous(labels = scales::comma) +
scale_fill_manual(values = fill_vals, name = "",
breaks = time_variant_stages) +
scale_pattern_manual(values = pattern_vals, name = "",
breaks = time_variant_stages) +
labs(
title = "",
x = "",
y = "Cumulative Adoption (%)"
) +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
plot.title = element_text(face = "bold", size = 16),
legend.position = "right",
strip.text = element_text(size = 14, face = "bold"),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank()
)

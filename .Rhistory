df %>%
summarise(
peer            = sum(DAC[str_detect(var, "peer")], na.rm = TRUE),
home_age            = sum(DAC[str_detect(var, "home_age")], na.rm = TRUE),
rangeanxiety    = sum(DAC[str_detect(var, "rangeanxiety")], na.rm = TRUE),
charging_5mile  = sum(DAC[str_detect(var, "charging_5mile_f1")], na.rm = TRUE)
) %>%
mutate(tech = ipt[k],
dac = "DAC")
)
rd
result
result <- data.frame()
for(k in 1:5){
b_ev <- mreg_dac(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
scenario = select_scene[[k]],
i = k,
future = fut[[k]][1])
df <- b_ev %>% t() %>%
as.data.frame() %>%
slice(-1) %>%
mutate(var = row.names(.)) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(non_DAC = `0`*rate,
DAC = `1`*rate)
rd <- df %>%
summarise(
peer            = sum(non_DAC[str_detect(var, "peer")], na.rm = TRUE),
home_age            = sum(non_DAC[str_detect(var, "home_age")], na.rm = TRUE),
rangeanxiety    = sum(non_DAC[str_detect(var, "rangeanxiety")], na.rm = TRUE),
charging_5mile  = sum(non_DAC[str_detect(var, "charging_5mile_f1")], na.rm = TRUE)
) %>%
mutate(tech = ipt[k],
dac = "Non_DAC") %>%
rbind(
df %>%
summarise(
peer            = sum(DAC[str_detect(var, "peer")], na.rm = TRUE),
home_age            = sum(DAC[str_detect(var, "home_age")], na.rm = TRUE),
rangeanxiety    = sum(DAC[str_detect(var, "rangeanxiety")], na.rm = TRUE),
charging_5mile  = sum(DAC[str_detect(var, "charging_5mile_f1")], na.rm = TRUE)
) %>%
mutate(tech = ipt[k],
dac = "DAC")
)
result <- rbind(rd, result)
}
result
k <- 2
b_ev <- mreg_dac(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
scenario = select_scene[[k]],
i = k,
future = fut[[k]][1])
df <- b_ev %>% t() %>%
as.data.frame() %>%
slice(-1) %>%
mutate(var = row.names(.)) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(non_DAC = `0`*rate,
DAC = `1`*rate)
df
rates <- list(c(0,0.2,-0.14,-0.23),
c(0,0.2,-0.04,-0.26,0.32,-2),
c(0,-0.25),
c(0,0.2,0,-0.17),
c(0,0.2,-0.14,-0.23))
df <- b_ev %>% t() %>%
as.data.frame() %>%
slice(-1) %>%
mutate(var = row.names(.)) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(non_DAC = `0`*rate,
DAC = `1`*rate)
df
k <- 3
b_ev <- mreg_dac(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
scenario = select_scene[[k]],
i = k,
future = fut[[k]][1])
df <- b_ev %>% t() %>%
as.data.frame() %>%
slice(-1) %>%
mutate(var = row.names(.)) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(non_DAC = `0`*rate,
DAC = `1`*rate)
df
k <- 5
b_ev <- mreg(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
i = k,
future = fut[[k]][1])
pattern <- paste(select_var[[k]], collapse = "|")
df <- b_ev[[4]] %>%
filter(str_detect(var, pattern)) %>%
dplyr::select(var, Estimate) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(effect = Estimate*rate)
rates <- list(c(0,0.2,-0.14,-0.23),
c(0,0.2,-0.04,-0.26,0.32,-2),
c(0,-0.25),
c(0,0.2,0,-0.17),
c(0,0.2,-0.14,-0.23))
b_ev <- mreg_dac(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
scenario = select_scene[[k]],
i = k,
future = fut[[k]][1])
df <- b_ev %>% t() %>%
as.data.frame() %>%
slice(-1) %>%
mutate(var = row.names(.)) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(non_DAC = `0`*rate,
DAC = `1`*rate)
df
k
b_ev <- mreg(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
i = k,
future = fut[[k]][1])
pattern <- paste(select_var[[k]], collapse = "|")
df <- b_ev[[4]] %>%
filter(str_detect(var, pattern)) %>%
dplyr::select(var, Estimate) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(effect = Estimate*rate)
df
k <- 2
b_ev <- mreg(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
i = k,
future = fut[[k]][1])
pattern <- paste(select_var[[k]], collapse = "|")
df <- b_ev[[4]] %>%
filter(str_detect(var, pattern)) %>%
dplyr::select(var, Estimate) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(effect = Estimate*rate)
df
k
b_ev <- mreg_dac(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
scenario = select_scene[[k]],
i = k,
future = fut[[k]][1])
df <- b_ev %>% t() %>%
as.data.frame() %>%
slice(-1) %>%
mutate(var = row.names(.)) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(non_DAC = `0`*rate,
DAC = `1`*rate)
df
### optimistic scenarios
select_var <- list(c("peer","home_age"),
c("peer","charging_5mile_f1","rangeanxiety","home_age"),
c("peer"),
c("peer","home_age"),
c("peer","home_age"))
rates <- list(c(0,0.2,-0.14,-0.23),
c(0,0.2,-2,0.32,-0.04,-0.26),
c(0,-0.25),
c(0,0.2,0,-0.17),
c(0,0.2,-0.14,-0.23))
b_ev <- mreg(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
i = k,
future = fut[[k]][1])
pattern <- paste(select_var[[k]], collapse = "|")
df <- b_ev[[4]] %>%
filter(str_detect(var, pattern)) %>%
dplyr::select(var, Estimate) %>%
cbind(tibble(rate = rates[[k]])) %>%
mutate(effect = Estimate*rate)
df
source("./syntax/Function.R")
ggsave <- function(..., bg = 'white') ggplot2::ggsave(..., bg = bg)
remove <- c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv", "education","employment")
# ML feature importance
tc_kfold <- trainControl(method = "cv", number = 10, returnResamp="all",
savePredictions = TRUE, classProbs = TRUE,
summaryFunction = twoClassSummary)
library(caret)
# ML feature importance
tc_kfold <- trainControl(method = "cv", number = 10, returnResamp="all",
savePredictions = TRUE, classProbs = TRUE,
summaryFunction = twoClassSummary)
k <- 1
b_ev <- mreg(read_csv("./data/raw/cca_15jul2025_weighted.csv") %>%
data_process(ev = c("Fully electric")) %>%
data_clean(1),
remove = c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv",
"education","employment"),
i = k)
b_ev
mreg_var <- function(data, remove = NULL, i){
# data <- read_csv("./data/raw/cca_15jul2025_weighted.csv") %>% data_process(ev = c("Fully electric")) %>% data_clean(1)
remove <- c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv", "education","employment")
# scenario <- c("peer_PV")
# i <- 5
# future <- 127
da_r <- data %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future")
) %>%
dplyr::select(-remove)
# binary
bina <- c(
"born_us",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"therm_winter",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# categorical variables:
cat <- c("race",
# "born_us",
"home_type",
"employment",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
# "charging_5mile_f",
# "vehicle_next_used",
# "vehicle_next_fuel",
# "charging_work",
"primary_heating_type",
"primary_cooling_type",
# "therm_winter",
"kitchen_range_type",
"electrification"
# "upfrontpayback",
# "outage_generatorown",
# "ccmove_where"
) %>%
setdiff(remove)
exclusions <- list(
c("peer_EV", "peer_HP", "peer_IC"),
c("peer_PV", "peer_HP", "peer_IC"),
c("peer_EV", "peer_PV", "peer_IC"),
c("peer_EV", "peer_HP", "peer_PV")
)
if(i %in% c(1,5)){
cat <- cat %>% setdiff(exclusions[[1]])
}else{
cat <- cat %>% setdiff(exclusions[[i]])
}
ftr <- c("climatezone",
"dac",
"race",
"born_us",
"home_type",
"employment",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"primary_heating_type",
"primary_cooling_type",
"therm_winter",
"kitchen_range_type",
"electrification",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# da$race %>% unique
da_r[,ftr] <- data.frame(lapply(da_r[ftr],as.factor))
# dummy sum contrast based on reference category (-1)
for (var in cat) {
k <- length(levels(da_r[[var]]))
contrasts(da_r[[var]]) <- contr.sum(k)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1:(k-1)]
}
# for binary
for (var in bina) {
da_r[[var]] <- factor(da_r[[var]], levels = c(1,0))
contrasts(da_r[[var]]) <- contr.sum(2)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1]
}
da_r <- da_r %>%
mutate(across(starts_with("peer"), ~factor(.x, levels = c("neighbor","peer","none")))) %>% # avoid the sum contrast
mutate(across(where(is.numeric) & !c("PV","PS","EV","HP","IC","wt_ca"), ~ scale(.) %>% as.numeric())) %>%
mutate(across(any_of(c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv")), ~ .x * -1))
if(i %in% c(1,5)){
# for PV, remove zone effect, tech
tract <- c("climatezone","dac","ev_wtp_pc","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_EV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 2){
# for EV, remove zone effect, tech
tract <- c("climatezone","dac","solstor_wtp_dv","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_IC","peer_HP","peer_PV",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 3){
# for HP, remove zone effect, tech, heating/cooling type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","induction_dv","wt_ca",
"peer_EV","peer_IC","peer_PV",
"PV","PS","EV","HP","IC","primary_heating_type","primary_cooling_type")
model1vars <- setdiff(names(da_r), tract)
}else{
# for IC, remove zone effect, tech, cooking type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","heatpump_wtp_pc","wt_ca",
"peer_EV","peer_HP","peer_PV",
"PV","PS","EV","HP","IC","kitchen_range_type")
model1vars <- setdiff(names(da_r), tract)
}
return(model1vars)
}
remove <- c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv", "education","employment")
mreg_var(data, i = 1)
i <- 1
ipt[i]
make.names(ipt[i])
i <- 2
make.names(ipt[i])
as.formula(paste(ipt[i], " ~", paste(mreg_var(data, i = 2)))
as.formula(paste(ipt[i], " ~", paste(mreg_var(data, i = 2))))
paste(mreg_var(data, i = 2))
as.formula(paste(ipt[i], " ~", paste(mreg_var(data, i = 2), collapse = " + ")))
mreg_var <- function(data, remove = NULL, i){
# data <- read_csv("./data/raw/cca_15jul2025_weighted.csv") %>% data_process(ev = c("Fully electric")) %>% data_clean(1)
remove <- c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv", "education","employment")
# scenario <- c("peer_PV")
# i <- 5
# future <- 127
da_r <- data %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future")
) %>%
dplyr::select(-remove)
# binary
bina <- c(
"born_us",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"therm_winter",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# categorical variables:
cat <- c("race",
# "born_us",
"home_type",
"employment",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
# "charging_5mile_f",
# "vehicle_next_used",
# "vehicle_next_fuel",
# "charging_work",
"primary_heating_type",
"primary_cooling_type",
# "therm_winter",
"kitchen_range_type",
"electrification"
# "upfrontpayback",
# "outage_generatorown",
# "ccmove_where"
) %>%
setdiff(remove)
exclusions <- list(
c("peer_EV", "peer_HP", "peer_IC"),
c("peer_PV", "peer_HP", "peer_IC"),
c("peer_EV", "peer_PV", "peer_IC"),
c("peer_EV", "peer_HP", "peer_PV")
)
if(i %in% c(1,5)){
cat <- cat %>% setdiff(exclusions[[1]])
}else{
cat <- cat %>% setdiff(exclusions[[i]])
}
ftr <- c("climatezone",
"dac",
"race",
"born_us",
"home_type",
"employment",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"primary_heating_type",
"primary_cooling_type",
"therm_winter",
"kitchen_range_type",
"electrification",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# da$race %>% unique
da_r[,ftr] <- data.frame(lapply(da_r[ftr],as.factor))
# dummy sum contrast based on reference category (-1)
for (var in cat) {
k <- length(levels(da_r[[var]]))
contrasts(da_r[[var]]) <- contr.sum(k)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1:(k-1)]
}
# for binary
for (var in bina) {
da_r[[var]] <- factor(da_r[[var]], levels = c(1,0))
contrasts(da_r[[var]]) <- contr.sum(2)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1]
}
da_r <- da_r %>%
mutate(across(starts_with("peer"), ~factor(.x, levels = c("neighbor","peer","none")))) %>% # avoid the sum contrast
mutate(across(where(is.numeric) & !c("PV","PS","EV","HP","IC","wt_ca"), ~ scale(.) %>% as.numeric())) %>%
mutate(across(any_of(c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv")), ~ .x * -1))
if(i %in% c(1,5)){
# for PV, remove zone effect, tech
tract <- c("climatezone","dac","ev_wtp_pc","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_EV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 2){
# for EV, remove zone effect, tech
tract <- c("climatezone","dac","solstor_wtp_dv","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_IC","peer_HP","peer_PV",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 3){
# for HP, remove zone effect, tech, heating/cooling type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","induction_dv","wt_ca",
"peer_EV","peer_IC","peer_PV",
"PV","PS","EV","HP","IC","primary_heating_type","primary_cooling_type")
model1vars <- setdiff(names(da_r), tract)
}else{
# for IC, remove zone effect, tech, cooking type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","heatpump_wtp_pc","wt_ca",
"peer_EV","peer_HP","peer_PV",
"PV","PS","EV","HP","IC","kitchen_range_type")
model1vars <- setdiff(names(da_r), tract)
}
return(list(da_r, model1vars))
}
# ML feature importance
tc_kfold <- trainControl(method = "cv", number = 10, returnResamp="all",
savePredictions = TRUE, classProbs = TRUE,
summaryFunction = twoClassSummary)
k <- 2
dt <- mreg_var(data, i = k)
fvar <- as.formula(paste(ipt[k], " ~", paste(dt[[2]], collapse = " + ")))
fvar
### GLM
glm <- train(form = fvar, data= dt[[1]], method = "glm",
trControl = tc_kfold,
na.action=na.omit,
family = 'binomial')
dt[[1]]
dt[[1]] %>% summary()

dac_r <- dac_sf %>%
mutate(sample = as.character(sample)) %>%
left_join(dc %>%
gather(scene, R_effect, names), by = c("sample" = "zone")) %>%
dplyr::select(sample,scene,R_effect)
re_slope <- zone_r %>%
st_drop_geometry() %>%
inner_join(dac_r %>%
st_drop_geometry(), by = c("scene")) %>%
unite(col = "group", BZone, sample, sep = "") %>%
mutate(R_effect = R_effect.x + R_effect.y) %>%
dplyr::select(-R_effect.x, -R_effect.y) %>%
pivot_wider(names_from = scene, values_from = R_effect)
re_slope
re_slope$home_ageNewer %>% mean()
da_r <- data %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future"),
) %>%
dplyr::select(-remove)
future <- fut[[i]][2] # optimistic
if(i == 1){
future_var <- sym(paste0("future_", ipt[i]))
}else{
future_var <- sym(paste0("future_", ipt[i],"_",future))
}
if(!is.null(future)){
da_r <- data %>%
mutate(!!ipt[i] := .data[[future_var]]) %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future")
) %>%
dplyr::select(-remove)
}
# binary
bina <- c(
"born_us",
# "charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"therm_winter",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# categorical variables:
cat <- c("race",
# "born_us",
"home_type",
"employment",
# "home_age",
# "peer_EV",
# "peer_PV",
# "peer_HP",
# "peer_IC",
# "charging_5mile_f",
# "vehicle_next_used",
# "vehicle_next_fuel",
# "charging_work",
"primary_heating_type",
"primary_cooling_type",
# "therm_winter",
"kitchen_range_type",
"electrification"
# "upfrontpayback",
# "outage_generatorown",
# "ccmove_where"
) %>%
setdiff(remove)
ftr <- c("climatezone",
"dac",
"race",
"born_us",
"home_type",
"employment",
"home_age",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"primary_heating_type",
"primary_cooling_type",
"therm_winter",
"kitchen_range_type",
"electrification",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# da$race %>% unique
da_r[,ftr] <- data.frame(lapply(da_r[ftr],as.factor))
# dummy sum contrast based on reference category (-1)
for (var in cat) {
k <- length(levels(da_r[[var]]))
contrasts(da_r[[var]]) <- contr.sum(k)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1:(k-1)]
}
# for binary
for (var in bina) {
da_r[[var]] <- factor(da_r[[var]], levels = c(1,0))
contrasts(da_r[[var]]) <- contr.sum(2)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1]
}
da_r <- da_r %>%
mutate(across(starts_with("peer"), ~factor(.x, levels = c("neighbor","peer","none")))) %>%
mutate(across(where(is.numeric) & !c("PV","PS","EV","HP","IC","wt_ca"), ~ scale(.) %>% as.numeric())) %>%
mutate(across(any_of(c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv")), ~ .x * -1))
if(i %in% c(1,5)){
# for PV, remove zone effect, tech, peer
tract <- c("climatezone","dac","ev_wtp_pc","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_EV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 2){
# for EV, remove zone effect, tech
tract <- c("climatezone","dac","solstor_wtp_dv","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_PV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 3){
# for HP, remove zone effect, tech, heating/cooling type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","induction_dv","wt_ca",
"peer_EV","peer_PV","peer_IC",
"PV","PS","EV","HP","IC","primary_heating_type","primary_cooling_type",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}else{
# for IC, remove zone effect, tech, cooking type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","heatpump_wtp_pc","wt_ca",
"peer_EV","peer_HP","peer_PV",
"PV","PS","EV","HP","IC","kitchen_range_type",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}
model1vars <- setdiff(model1vars, scenario)
if (is.null(scenario)) {
fvar <- as.formula(paste(ipt[i], " ~", paste(model1vars, collapse = " + "),
"+ (1|climatezone) + (1|dac)"))
} else {
fvar <- as.formula(paste(ipt[i], " ~", paste(model1vars, collapse = " + "),
"+ (1+",paste(scenario, collapse = " + "),"|climatezone) + (1+",paste(scenario, collapse = " + "),
"|dac)"))
}
fit <- lmer(fvar, weights = wt_ca, data = da_r)
names <- ranef(fit)[[1]] %>% colnames()
ds <- ranef(fit)[[1]] %>%
rownames_to_column("zone")
dc <- ranef(fit)[[2]] %>%
rownames_to_column("zone")
zone_r <- cz %>%
left_join(ds %>%
gather(scene, R_effect, names), by = c("BZone" = "zone")) %>%
dplyr::select(BZone,scene,R_effect)
dac_r <- dac_sf %>%
mutate(sample = as.character(sample)) %>%
left_join(dc %>%
gather(scene, R_effect, names), by = c("sample" = "zone")) %>%
dplyr::select(sample,scene,R_effect)
re_slope <- zone_r %>%
st_drop_geometry() %>%
inner_join(dac_r %>%
st_drop_geometry(), by = c("scene")) %>%
unite(col = "group", BZone, sample, sep = "") %>%
mutate(R_effect = R_effect.x + R_effect.y) %>%
dplyr::select(-R_effect.x, -R_effect.y) %>%
pivot_wider(names_from = scene, values_from = R_effect)
re_slope$home_ageNewer %>% mean()
future <- 0
da_r <- data %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future"),
) %>%
dplyr::select(-remove)
future <- fut[[i]][2] # optimistic
future <- 0
if(i == 1){
future_var <- sym(paste0("future_", ipt[i]))
}else{
future_var <- sym(paste0("future_", ipt[i],"_",future))
}
if(!is.null(future)){
da_r <- data %>%
mutate(!!ipt[i] := .data[[future_var]]) %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future")
) %>%
dplyr::select(-remove)
}
# binary
bina <- c(
"born_us",
# "charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"therm_winter",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# categorical variables:
cat <- c("race",
# "born_us",
"home_type",
"employment",
# "home_age",
# "peer_EV",
# "peer_PV",
# "peer_HP",
# "peer_IC",
# "charging_5mile_f",
# "vehicle_next_used",
# "vehicle_next_fuel",
# "charging_work",
"primary_heating_type",
"primary_cooling_type",
# "therm_winter",
"kitchen_range_type",
"electrification"
# "upfrontpayback",
# "outage_generatorown",
# "ccmove_where"
) %>%
setdiff(remove)
ftr <- c("climatezone",
"dac",
"race",
"born_us",
"home_type",
"employment",
"home_age",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"primary_heating_type",
"primary_cooling_type",
"therm_winter",
"kitchen_range_type",
"electrification",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# da$race %>% unique
da_r[,ftr] <- data.frame(lapply(da_r[ftr],as.factor))
# dummy sum contrast based on reference category (-1)
for (var in cat) {
k <- length(levels(da_r[[var]]))
contrasts(da_r[[var]]) <- contr.sum(k)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1:(k-1)]
}
# for binary
for (var in bina) {
da_r[[var]] <- factor(da_r[[var]], levels = c(1,0))
contrasts(da_r[[var]]) <- contr.sum(2)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1]
}
da_r <- da_r %>%
mutate(across(starts_with("peer"), ~factor(.x, levels = c("neighbor","peer","none")))) %>%
mutate(across(where(is.numeric) & !c("PV","PS","EV","HP","IC","wt_ca"), ~ scale(.) %>% as.numeric())) %>%
mutate(across(any_of(c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv")), ~ .x * -1))
if(i %in% c(1,5)){
# for PV, remove zone effect, tech, peer
tract <- c("climatezone","dac","ev_wtp_pc","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_EV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 2){
# for EV, remove zone effect, tech
tract <- c("climatezone","dac","solstor_wtp_dv","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_PV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 3){
# for HP, remove zone effect, tech, heating/cooling type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","induction_dv","wt_ca",
"peer_EV","peer_PV","peer_IC",
"PV","PS","EV","HP","IC","primary_heating_type","primary_cooling_type",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}else{
# for IC, remove zone effect, tech, cooking type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","heatpump_wtp_pc","wt_ca",
"peer_EV","peer_HP","peer_PV",
"PV","PS","EV","HP","IC","kitchen_range_type",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}
model1vars <- setdiff(model1vars, scenario)
if (is.null(scenario)) {
fvar <- as.formula(paste(ipt[i], " ~", paste(model1vars, collapse = " + "),
"+ (1|climatezone) + (1|dac)"))
} else {
fvar <- as.formula(paste(ipt[i], " ~", paste(model1vars, collapse = " + "),
"+ (1+",paste(scenario, collapse = " + "),"|climatezone) + (1+",paste(scenario, collapse = " + "),
"|dac)"))
}
fit <- lmer(fvar, weights = wt_ca, data = da_r)
names <- ranef(fit)[[1]] %>% colnames()
ds <- ranef(fit)[[1]] %>%
rownames_to_column("zone")
dc <- ranef(fit)[[2]] %>%
rownames_to_column("zone")
zone_r <- cz %>%
left_join(ds %>%
gather(scene, R_effect, names), by = c("BZone" = "zone")) %>%
dplyr::select(BZone,scene,R_effect)
dac_r <- dac_sf %>%
mutate(sample = as.character(sample)) %>%
left_join(dc %>%
gather(scene, R_effect, names), by = c("sample" = "zone")) %>%
dplyr::select(sample,scene,R_effect)
re_slope <- zone_r %>%
st_drop_geometry() %>%
inner_join(dac_r %>%
st_drop_geometry(), by = c("scene")) %>%
unite(col = "group", BZone, sample, sep = "") %>%
mutate(R_effect = R_effect.x + R_effect.y) %>%
dplyr::select(-R_effect.x, -R_effect.y) %>%
pivot_wider(names_from = scene, values_from = R_effect)
re_slope$home_ageNewer %>% mean()
da_r <- data %>%
dplyr::select(# remove multicollinear variables
# remove predictors with substantial NAs
-heatpump_direct,-induction_direct,
# remove future adoption
-starts_with("future"),
) %>%
dplyr::select(-remove)
# binary
bina <- c(
"born_us",
# "charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"therm_winter",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# categorical variables:
cat <- c("race",
# "born_us",
"home_type",
"employment",
# "home_age",
# "peer_EV",
# "peer_PV",
# "peer_HP",
# "peer_IC",
# "charging_5mile_f",
# "vehicle_next_used",
# "vehicle_next_fuel",
# "charging_work",
"primary_heating_type",
"primary_cooling_type",
# "therm_winter",
"kitchen_range_type",
"electrification"
# "upfrontpayback",
# "outage_generatorown",
# "ccmove_where"
) %>%
setdiff(remove)
ftr <- c("climatezone",
"dac",
"race",
"born_us",
"home_type",
"employment",
"home_age",
"peer_EV",
"peer_PV",
"peer_HP",
"peer_IC",
"charging_5mile_f",
"vehicle_next_used",
# "vehicle_next_fuel",
"charging_work",
"primary_heating_type",
"primary_cooling_type",
"therm_winter",
"kitchen_range_type",
"electrification",
"upfrontpayback",
"outage_generatorown",
"ccmove_where"
) %>%
setdiff(remove)
# da$race %>% unique
da_r[,ftr] <- data.frame(lapply(da_r[ftr],as.factor))
# dummy sum contrast based on reference category (-1)
for (var in cat) {
k <- length(levels(da_r[[var]]))
contrasts(da_r[[var]]) <- contr.sum(k)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1:(k-1)]
}
# for binary
for (var in bina) {
da_r[[var]] <- factor(da_r[[var]], levels = c(1,0))
contrasts(da_r[[var]]) <- contr.sum(2)
colnames(contrasts(da_r[[var]])) <- levels(da_r[[var]])[1]
}
da_r <- da_r %>%
mutate(across(starts_with("peer"), ~factor(.x, levels = c("neighbor","peer","none")))) %>%
mutate(across(where(is.numeric) & !c("PV","PS","EV","HP","IC","wt_ca"), ~ scale(.) %>% as.numeric())) %>%
mutate(across(any_of(c("solstor_wtp_dv","ev_wtp_pc","heatpump_wtp_pc","induction_dv")), ~ .x * -1))
if(i %in% c(1,5)){
# for PV, remove zone effect, tech, peer
tract <- c("climatezone","dac","ev_wtp_pc","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_EV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 2){
# for EV, remove zone effect, tech
tract <- c("climatezone","dac","solstor_wtp_dv","heatpump_wtp_pc","induction_dv","wt_ca",
"peer_PV","peer_HP","peer_IC",
"PV","PS","EV","HP","IC")
model1vars <- setdiff(names(da_r), tract)
}else if(i == 3){
# for HP, remove zone effect, tech, heating/cooling type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","induction_dv","wt_ca",
"peer_EV","peer_PV","peer_IC",
"PV","PS","EV","HP","IC","primary_heating_type","primary_cooling_type",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}else{
# for IC, remove zone effect, tech, cooking type
tract <- c("climatezone","dac","ev_wtp_pc","solstor_wtp_dv","heatpump_wtp_pc","wt_ca",
"peer_EV","peer_HP","peer_PV",
"PV","PS","EV","HP","IC","kitchen_range_type",
"charging_5mile_f","rangeanxiety","vehicle_1_miles","charging_work","vehicle_next_used")
model1vars <- setdiff(names(da_r), tract)
}
model1vars <- setdiff(model1vars, scenario)
if (is.null(scenario)) {
fvar <- as.formula(paste(ipt[i], " ~", paste(model1vars, collapse = " + "),
"+ (1|climatezone) + (1|dac)"))
} else {
fvar <- as.formula(paste(ipt[i], " ~", paste(model1vars, collapse = " + "),
"+ (1+",paste(scenario, collapse = " + "),"|climatezone) + (1+",paste(scenario, collapse = " + "),
"|dac)"))
}
fit <- lmer(fvar, weights = wt_ca, data = da_r)
names <- ranef(fit)[[1]] %>% colnames()
ds <- ranef(fit)[[1]] %>%
rownames_to_column("zone")
dc <- ranef(fit)[[2]] %>%
rownames_to_column("zone")
zone_r <- cz %>%
left_join(ds %>%
gather(scene, R_effect, names), by = c("BZone" = "zone")) %>%
dplyr::select(BZone,scene,R_effect)
dac_r <- dac_sf %>%
mutate(sample = as.character(sample)) %>%
left_join(dc %>%
gather(scene, R_effect, names), by = c("sample" = "zone")) %>%
dplyr::select(sample,scene,R_effect)
re_slope <- zone_r %>%
st_drop_geometry() %>%
inner_join(dac_r %>%
st_drop_geometry(), by = c("scene")) %>%
unite(col = "group", BZone, sample, sep = "") %>%
mutate(R_effect = R_effect.x + R_effect.y) %>%
dplyr::select(-R_effect.x, -R_effect.y) %>%
pivot_wider(names_from = scene, values_from = R_effect)
re_slope$home_ageNewer %>% mean()
View(combined_df_wide)
mrp
ipt
combined_df_wide <- combined_df %>%
dplyr::select(-Effect) %>%
pivot_wider(names_from = class, values_from = c(MRP,Final)) %>%
left_join(mrp %>%
dplyr::select(GEOID, which(str_detect(names(.), "_0"))), by = "GEOID")
source("./syntax/Function.R")
ggsave <- function(..., bg = 'white') ggplot2::ggsave(..., bg = bg)
mrp <- read_csv("./data/raw/mrp_scenariovars_tract.csv")
mrp
CA_t
load("./data/dac_sf.RData") # CA_t, cz, dac_sf, sc_map (DAC, climate zone spatial data)
